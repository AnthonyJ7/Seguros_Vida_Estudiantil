<div class="max-w-7xl mx-auto mt-12 p-8 space-y-8">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h2 class="text-4xl font-black text-slate-800">Revisi√≥n de Tr√°mites</h2>
      <p class="text-slate-500 mt-2">Aprueba o rechaza los tr√°mites enviados por el gestor</p>
    </div>
    <button (click)="toggleHistorial()" 
            class="px-6 py-3 rounded-xl font-bold transition-all"
            [class]="mostrarHistorial ? 'bg-slate-200 text-slate-700 hover:bg-slate-300' : 'bg-indigo-600 text-white hover:bg-indigo-700'">
      {{ mostrarHistorial ? '‚Üê Ver Pendientes' : 'üìú Ver Historial' }}
    </button>
  </div>

  <!-- Notificaciones / Registro de Notificaciones -->
  <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl shadow-lg border-2 border-amber-200 overflow-hidden">
    <div class="flex items-center justify-between p-6 bg-white border-b-2 border-amber-200">
      <div class="flex items-center gap-4">
        <span class="text-3xl">üîî</span>
        <div>
          <h3 class="text-lg font-black text-slate-800">
            {{ mostrarRegistroNotificaciones ? 'Registro de Notificaciones' : 'Notificaciones Pendientes' }}
          </h3>
          <p class="text-xs text-slate-500 mt-1">
            {{ mostrarRegistroNotificaciones ? 'Todas las notificaciones recibidas' : 'Requieren tu atenci√≥n' }}
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="inline-block text-xs px-4 py-2 rounded-full font-bold" [ngClass]="mostrarRegistroNotificaciones ? 'bg-slate-100 text-slate-700' : 'bg-amber-100 text-amber-800'">
          <span *ngIf="!mostrarRegistroNotificaciones">
            {{ notificacionesPendientes.length }} pendiente(s)
          </span>
          <span *ngIf="mostrarRegistroNotificaciones">
            {{ notificacionesRegistro.length }} total
          </span>
        </span>
        <button (click)="toggleRegistroNotificaciones()" 
                class="px-4 py-2 rounded-lg text-sm font-bold transition-all"
                [class]="mostrarRegistroNotificaciones ? 'bg-slate-200 text-slate-700 hover:bg-slate-300' : 'bg-amber-600 text-white hover:bg-amber-700'">
          {{ mostrarRegistroNotificaciones ? '‚Üê Ver Pendientes' : 'üìã Ver Registro' }}
        </button>
      </div>
    </div>

    <div class="p-6 space-y-3 max-h-96 overflow-y-auto">
      <!-- Notificaciones Pendientes -->
      <div *ngIf="!mostrarRegistroNotificaciones && notificacionesPendientes.length > 0">
        <div *ngFor="let n of notificacionesPendientes" class="p-4 rounded-xl border-2 border-amber-300 bg-white hover:shadow-lg transition-all flex gap-4 items-start group">
          <div class="text-2xl flex-shrink-0">{{ getIconoNotificacion(n) }}</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-bold text-slate-800">{{ n.titulo || n.mensaje }}</p>
            <p class="text-xs text-slate-600 mt-1 line-clamp-2">{{ n.mensaje }}</p>
            <div class="flex gap-2 mt-2 flex-wrap">
              <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">
                {{ n.tipo || 'N/A' }}
              </span>
              <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">
                {{ n.fechaEnvio | date:'short' }}
              </span>
            </div>
          </div>
          <button 
            (click)="marcarNotificacionLeida(n)"
            [disabled]="marcandoNotificacionId === (n.id || n.idNotificacion)"
            class="px-3 py-2 text-xs rounded-lg bg-amber-600 text-white font-semibold hover:bg-amber-700 disabled:bg-gray-400 transition-all whitespace-nowrap flex-shrink-0">
            {{ marcandoNotificacionId === (n.id || n.idNotificacion) ? '...' : '‚úì' }}
          </button>
        </div>

        <!-- Sin notificaciones pendientes -->
        <div *ngIf="notificacionesPendientes.length === 0" class="p-8 text-center">
          <p class="text-slate-500 text-sm">No hay notificaciones pendientes.</p>
        </div>
      </div>

      <!-- Registro Completo de Notificaciones -->
      <div *ngIf="mostrarRegistroNotificaciones">
        <div *ngFor="let n of notificacionesRegistro" [class]="'p-4 rounded-xl border-2 hover:shadow-lg transition-all flex gap-4 items-start ' + (n.leida ? 'border-slate-200 bg-slate-50' : 'border-amber-300 bg-white')">
          <div class="text-2xl flex-shrink-0">{{ getIconoNotificacion(n) }}</div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <p class="text-sm font-bold text-slate-800">{{ n.titulo || n.mensaje }}</p>
              <span *ngIf="n.leida" class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold flex-shrink-0">‚úì Le√≠da</span>
            </div>
            <p class="text-xs text-slate-600 mt-1 line-clamp-2">{{ n.mensaje }}</p>
            <div class="flex gap-2 mt-2 flex-wrap">
              <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">
                {{ n.tipo || 'N/A' }}
              </span>
              <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">
                {{ n.fechaEnvio | date:'short' }}
              </span>
              <span *ngIf="n.fechaLectura" class="text-xs px-2 py-1 rounded bg-emerald-100 text-emerald-700">
                ‚úì {{ n.fechaLectura | date:'short' }}
              </span>
            </div>
          </div>
          <button 
            *ngIf="!n.leida"
            (click)="marcarNotificacionLeida(n)"
            [disabled]="marcandoNotificacionId === (n.id || n.idNotificacion)"
            class="px-3 py-2 text-xs rounded-lg bg-amber-600 text-white font-semibold hover:bg-amber-700 disabled:bg-gray-400 transition-all whitespace-nowrap flex-shrink-0">
            {{ marcandoNotificacionId === (n.id || n.idNotificacion) ? '...' : '‚úì' }}
          </button>
        </div>
        
        <!-- Sin notificaciones en registro -->
        <div *ngIf="notificacionesRegistro.length === 0" class="p-8 text-center">
          <p class="text-slate-500 text-sm">No hay notificaciones en el registro.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div *ngIf="mensaje" class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-700 font-bold">
    {{ mensaje }}
  </div>
  <div *ngIf="error" class="p-4 bg-red-50 border border-red-200 rounded-xl text-red-600 font-bold">
    {{ error }}
  </div>

  <!-- Cargando -->
  <div *ngIf="cargando" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    <p class="mt-4 text-slate-500">Cargando tr√°mites pendientes...</p>
  </div>

  <!-- Sin tr√°mites pendientes -->
  <div *ngIf="!cargando && tramitesPendientes.length === 0" class="text-center py-12 bg-slate-50 rounded-xl border border-slate-200">
    <span class="text-6xl">‚úÖ</span>
    <p class="text-slate-500 text-lg mt-4">No hay tr√°mites pendientes de revisi√≥n.</p>
  </div>

  <!-- Tabla de Tr√°mites Pendientes -->
  <div *ngIf="!cargando && !mostrarHistorial && tramitesPendientes.length > 0" class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-600 to-indigo-500 text-white p-6">
      <h3 class="text-xl font-black">Tr√°mites Pendientes de Aprobaci√≥n</h3>
      <p class="text-indigo-100 text-sm mt-1">{{ tramitesPendientes.length }} tr√°mite(s) esperando revisi√≥n</p>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-slate-100 border-b border-slate-200">
          <tr>
            <th class="text-left py-4 px-6 font-bold text-slate-700">C√≥digo</th>
            <th class="text-left py-4 px-6 font-bold text-slate-700">Estudiante</th>
            <th class="text-left py-4 px-6 font-bold text-slate-700">Tipo</th>
            <th class="text-left py-4 px-6 font-bold text-slate-700">Descripci√≥n</th>
            <th class="text-center py-4 px-6 font-bold text-slate-700">Estado</th>
            <th class="text-left py-4 px-6 font-bold text-slate-700">Fecha</th>
            <th class="text-center py-4 px-6 font-bold text-slate-700">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let tramite of tramitesPendientes; trackBy: trackByTramiteId">
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 font-mono font-bold text-indigo-600">{{ tramite.codigoUnico || tramite.id }}</td>
              <td class="py-4 px-6">
                <div *ngIf="tramite.estudiante">
                  <p class="font-bold text-slate-800">{{ tramite.estudiante.nombreCompleto }}</p>
                  <p class="text-xs text-slate-500">{{ tramite.estudiante.cedula }}</p>
                </div>
                <span *ngIf="!tramite.estudiante" class="text-slate-400">N/A</span>
              </td>
              <td class="py-4 px-6">
                <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg text-sm font-bold">
                  {{ getTipoLabel(tramite.tipoTramite) }}
                </span>
              </td>
              <td class="py-4 px-6 text-sm text-slate-600">{{ tramite.descripcion || 'Sin descripci√≥n' }}</td>
              <td class="py-4 px-6 text-center">
                <span [class]="'px-3 py-1 rounded-lg text-xs font-bold ' + getEstadoColor(tramite.estadoCaso)">
                  {{ tramite.estadoCaso.toUpperCase() || 'N/A' }}
                </span>
              </td>
              <td class="py-4 px-6 text-sm text-slate-600">{{ tramite.fechaRegistro | date:'short' }}</td>
              <td class="py-4 px-6">
                <div class="flex gap-2 justify-center">
                  <button (click)="aprobarTramite(tramite)"
                          class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition-all text-sm">
                    ‚úì Listo para Aprobar
                  </button>
                  <button (click)="abrirModalRechazo(tramite)"
                          class="px-4 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition-all text-sm">
                    ‚ö†Ô∏è Requiere Correcciones
                  </button>
                  <button (click)="toggleDocumentos(tramite)"
                          class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all text-sm">
                    üìÑ {{ documentosVisibles[tramite.id] ? 'Ocultar' : 'Ver' }} Documentos
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="documentosVisibles[tramite.id]">
              <td [attr.colspan]="7" class="bg-slate-50 px-6 py-4">
                <div class="flex items-center justify-between mb-3">
                  <h4 class="text-sm font-black text-slate-700">Documentos del tr√°mite {{ tramite.codigoUnico || tramite.id }}</h4>
                  <span *ngIf="documentosCargandoId === tramite.id" class="text-xs text-slate-500">Cargando...</span>
                </div>
                <div *ngIf="(documentosPorTramite[tramite.id] || []).length === 0 && documentosCargandoId !== tramite.id" class="text-xs text-slate-500">No hay documentos.</div>
                <div *ngIf="(documentosPorTramite[tramite.id] || []).length > 0" class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead>
                      <tr class="bg-slate-100">
                        <th class="text-left py-2 px-3 font-bold text-slate-700">Tipo</th>
                        <th class="text-left py-2 px-3 font-bold text-slate-700">Nombre</th>
                        <th class="text-left py-2 px-3 font-bold text-slate-700">Fecha</th>
                        <th class="text-left py-2 px-3 font-bold text-slate-700">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let doc of documentosPorTramite[tramite.id]" class="border-b border-slate-200">
                        <td class="py-2 px-3">{{ doc.tipo || 'N/A' }}</td>
                        <td class="py-2 px-3">{{ doc.nombreArchivo }}</td>
                        <td class="py-2 px-3">{{ doc.fechaCarga | date:'short' }}</td>
                        <td class="py-2 px-3">
                          <a *ngIf="doc.url" [href]="doc.url" target="_blank" class="text-indigo-600 hover:underline font-semibold">Ver/Descargar</a>
                          <span *ngIf="!doc.url" class="text-slate-400">Sin enlace</span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Historial de Tr√°mites -->
  <div *ngIf="mostrarHistorial" class="space-y-6">
    <!-- Cargando historial -->
    <div *ngIf="cargandoHistorial" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
      <p class="mt-4 text-slate-500">Cargando historial...</p>
    </div>

    <!-- Sin historial -->
    <div *ngIf="!cargandoHistorial && tramitesHistorial.length === 0" class="text-center py-12 bg-slate-50 rounded-xl border border-slate-200">
      <span class="text-6xl">üìã</span>
      <p class="text-slate-500 text-lg mt-4">No hay tr√°mites en el historial.</p>
    </div>

    <!-- Tabla de Historial -->
    <div *ngIf="!cargandoHistorial && tramitesHistorial.length > 0" class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
      <div class="bg-gradient-to-r from-slate-700 to-slate-600 text-white p-6">
        <h3 class="text-xl font-black">Historial de Tr√°mites Procesados</h3>
        <p class="text-slate-200 text-sm mt-1">{{ tramitesHistorial.length }} tr√°mite(s) aprobados o rechazados</p>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-100 border-b border-slate-200">
            <tr>
              <th class="text-left py-4 px-6 font-bold text-slate-700">C√≥digo</th>
              <th class="text-left py-4 px-6 font-bold text-slate-700">Estudiante</th>
              <th class="text-left py-4 px-6 font-bold text-slate-700">Tipo</th>
              <th class="text-left py-4 px-6 font-bold text-slate-700">Descripci√≥n</th>
              <th class="text-center py-4 px-6 font-bold text-slate-700">Estado</th>
              <th class="text-left py-4 px-6 font-bold text-slate-700">Fecha Proceso</th>
              <th class="text-left py-4 px-6 font-bold text-slate-700">Observaci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let tramite of tramitesHistorial; trackBy: trackByTramiteId">
              <tr class="border-b border-slate-100 hover:bg-slate-50">
                <td class="py-4 px-6 font-mono font-bold text-indigo-600">{{ tramite.codigoUnico || tramite.id }}</td>
                <td class="py-4 px-6">
                  <div *ngIf="tramite.estudiante">
                    <p class="font-bold text-slate-800">{{ tramite.estudiante.nombreCompleto }}</p>
                    <p class="text-xs text-slate-500">{{ tramite.estudiante.cedula }}</p>
                  </div>
                  <span *ngIf="!tramite.estudiante" class="text-slate-400">N/A</span>
                </td>
                <td class="py-4 px-6">
                  <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg text-sm font-bold">
                    {{ getTipoLabel(tramite.tipoTramite) }}
                  </span>
                </td>
                <td class="py-4 px-6 text-sm text-slate-600">{{ tramite.descripcion || 'Sin descripci√≥n' }}</td>
                <td class="py-4 px-6 text-center">
                  <span [class]="'px-3 py-1 rounded-lg text-xs font-bold ' + getEstadoColor(tramite.estadoCaso)">
                    {{ tramite.estadoCaso.toUpperCase() || 'N/A' }}
                  </span>
                </td>
                <td class="py-4 px-6 text-sm text-slate-600">
                  {{ (tramite.fechaRevisionAseguradora || tramite.fechaAprobacion || tramite.fechaRechazo) | date:'short' }}
                </td>
                <td class="py-4 px-6 text-sm text-slate-600">
                  <span *ngIf="tramite.motivoRevisionAseguradora" class="text-orange-600 font-semibold">
                    {{ tramite.motivoRevisionAseguradora }}
                  </span>
                  <span *ngIf="!tramite.motivoRevisionAseguradora && tramite.estadoCaso.toLowerCase().includes('revisado')" class="text-blue-600 font-semibold">
                    ‚úì En espera de gestor
                  </span>
                  <span *ngIf="tramite.motivoRechazo && !tramite.motivoRevisionAseguradora" class="text-red-600 font-semibold">
                    {{ tramite.motivoRechazo }}
                  </span>
                  <span *ngIf="!tramite.motivoRechazo && !tramite.motivoRevisionAseguradora && tramite.estadoCaso.toLowerCase().includes('aprobado')" class="text-emerald-600 font-semibold">
                    Aprobado
                  </span>
                </td>
              </tr>
              <tr>
                <td [attr.colspan]="7" class="px-6 py-2">
                  <button (click)="toggleDocumentos(tramite)"
                          class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition-all text-xs">
                    üìÑ {{ documentosVisibles[tramite.id] ? 'Ocultar' : 'Ver' }} Documentos
                  </button>
                </td>
              </tr>
              <tr *ngIf="documentosVisibles[tramite.id]">
                <td [attr.colspan]="7" class="bg-slate-50 px-6 py-3">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-black text-slate-700">Documentos del tr√°mite {{ tramite.codigoUnico || tramite.id }}</h4>
                    <span *ngIf="documentosCargandoId === tramite.id" class="text-xs text-slate-500">Cargando...</span>
                  </div>
                  <div *ngIf="(documentosPorTramite[tramite.id] || []).length === 0 && documentosCargandoId !== tramite.id" class="text-xs text-slate-500">No hay documentos.</div>
                  <div *ngIf="(documentosPorTramite[tramite.id] || []).length > 0" class="overflow-x-auto">
                    <table class="w-full text-sm">
                      <thead>
                        <tr class="bg-slate-100">
                          <th class="text-left py-2 px-3 font-bold text-slate-700">Tipo</th>
                          <th class="text-left py-2 px-3 font-bold text-slate-700">Nombre</th>
                          <th class="text-left py-2 px-3 font-bold text-slate-700">Fecha</th>
                          <th class="text-left py-2 px-3 font-bold text-slate-700">Acciones</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let doc of documentosPorTramite[tramite.id]" class="border-b border-slate-200">
                          <td class="py-2 px-3">{{ doc.tipo || 'N/A' }}</td>
                          <td class="py-2 px-3">{{ doc.nombreArchivo }}</td>
                          <td class="py-2 px-3">{{ doc.fechaCarga | date:'short' }}</td>
                          <td class="py-2 px-3">
                            <a *ngIf="doc.url" [href]="doc.url" target="_blank" class="text-indigo-600 hover:underline font-semibold">Ver/Descargar</a>
                            <span *ngIf="!doc.url" class="text-slate-400">Sin enlace</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Rechazo -->
<div *ngIf="tramiteSeleccionado" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-black text-slate-800">Motivo de Correcciones</h3>
      <button (click)="cerrarModal()" class="text-slate-400 hover:text-slate-600 text-2xl">‚úï</button>
    </div>

    <div class="mb-4">
      <p class="text-sm text-slate-600 mb-2">
        <span class="font-bold">C√≥digo:</span> {{ tramiteSeleccionado.codigoUnico || tramiteSeleccionado.id }}
      </p>
      <p class="text-sm text-slate-600">
        <span class="font-bold">Estudiante:</span> {{ tramiteSeleccionado.estudiante?.nombreCompleto || 'N/A' }}
      </p>
    </div>

    <div class="mb-4">
      <label class="block text-xs font-bold text-slate-600 uppercase mb-2">Motivo de Correcciones *</label>
      <textarea [(ngModel)]="motivoRechazo"
                rows="4"
                class="w-full px-4 py-3 border border-slate-200 rounded-lg focus:border-orange-500 outline-none"
                placeholder="Indique qu√© correcciones se requieren..."></textarea>
    </div>

    <div class="flex gap-3">
      <button (click)="rechazarTramite()"
              class="flex-1 px-6 py-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 transition-all">
        Notificar Correcciones
      </button>
      <button (click)="cerrarModal()"
              class="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-all">
        Cancelar
      </button>
    </div>
  </div>
</div>

